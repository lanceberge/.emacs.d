* Table of Contents                                                   :TOC:
- [[#early-init][Early-Init]]
  - [[#initial-settings][Initial Settings]]
  - [[#straight][Straight]]
  - [[#ui][UI]]
- [[#init][Init]]
- [[#initial][Initial]]
  - [[#settings][Settings]]
  - [[#os-specific][OS Specific]]
  - [[#defer-incrementally][Defer Incrementally]]
  - [[#keybindingpackage-management][Keybinding/Package Management]]
  - [[#built-in-packages][Built-in Packages]]
  - [[#keybindings][Keybindings]]
  - [[#hooks][Hooks]]
  - [[#functions][Functions]]
- [[#evil-mode][Evil Mode]]
  - [[#evil][Evil]]
  - [[#evil-collection][Evil-Collection]]
  - [[#extra-operatorsmotions][Extra operators/motions]]
  - [[#miscellaneous][Miscellaneous]]
- [[#completion][Completion]]
  - [[#ivy][Ivy]]
  - [[#yasnippet][Yasnippet]]
  - [[#company][Company]]
- [[#version-control][Version Control]]
  - [[#functions-1][Functions]]
- [[#lsp-related][LSP-Related]]
- [[#ui-1][UI]]
- [[#org][Org]]
  - [[#org-1][Org]]
  - [[#org-built-ins][Org built-ins]]
  - [[#non-built-ins][Non built-ins]]
  - [[#functions-2][Functions]]
- [[#windows-buffers-tabs][Windows, Buffers, Tabs]]
  - [[#windows][Windows]]
  - [[#tabs][Tabs]]
- [[#editing][Editing]]
  - [[#smartparens][Smartparens]]
  - [[#miscellaneous-1][Miscellaneous]]
- [[#system][System]]
  - [[#terminal][Terminal]]
  - [[#eshell][Eshell]]
  - [[#tramp][Tramp]]
  - [[#dired][Dired]]
  - [[#miscellaneous-2][Miscellaneous]]
  - [[#functions-3][Functions]]
- [[#filetype-specific][Filetype Specific]]
  - [[#c-family][C family]]
  - [[#r][R]]
  - [[#markdown][Markdown]]
  - [[#python][Python]]
  - [[#matlab][Matlab]]
  - [[#latex][Latex]]
  - [[#javascript][Javascript]]
  - [[#scala][Scala]]
  - [[#go][Go]]
  - [[#yaml][Yaml]]
  - [[#docker][Docker]]
  - [[#html--css][HTML & CSS]]
  - [[#elisp-mode][Elisp Mode]]

* Early-Init

Tangles to early-init.el

** Initial Settings
#+BEGIN_SRC emacs-lisp :results none :tangle ~/.emacs.d/early-init.el
;;; -*- lexical-binding: t -*-
;; increase GC threshold until startup (in Initial section under hooks)
(setq gc-cons-threshold most-positive-fixnum)

(defconst IS-LINUX   (eq system-type   'gnu/linux))
(defconst IS-WINDOWS (memq system-type '(cygwin windows-nt ms-dos)))
(defconst IS-MAC     (eq system-type   'darwin))

(setq package-enable-at-startup nil) ; disable package.el at startup
(advice-add #'package--ensure-init-file :override #'ignore)

;; No unnecessary noise: toolbar, menu-bar, and scroll-bar
(push '(menu-bar-lines . 0) default-frame-alist)
(push '(tool-bar-lines . 0) default-frame-alist)
(push '(vertical-scroll-bars) default-frame-alist)

(setq emacs-load-start-time (current-time)
      menu-bar-mode nil
      tool-bar-mode nil
      scroll-bar-mode nil
      frame-inhibit-implied-resize t
      inhibit-default-init t
      site-run-file nil)

(set-face-attribute 'default nil ; font
                    :family "DejaVu Sans Mono"
                    :height 160
                    :weight 'normal
                    :width 'normal)

(advice-add #'x-apply-session-resources :override #'ignore)
#+END_SRC
** Straight
#+BEGIN_SRC emacs-lisp :results none :tangle ~/.emacs.d/early-init.el
;; Bootstrap straight.el - my package manager
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 5))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

;; use-package uses straight.el
(setq straight-use-package-by-default t
      straight-repository-branch "develop"
      straight-check-for-modifications nil
      straight-vc-git-default-clone-depth 1
      straight-fix-org nil
      comp-deferred-compilation t) ; defer elisp compilation, great with native-comp branch

(straight-use-package 'use-package)
(setq use-package-verbose t) ; show which packages are being loaded on startup and when
#+END_SRC
** UI
#+BEGIN_SRC emacs-lisp :results none :tangle ~/.emacs.d/early-init.el
(defconst bg-color "#282828"
  "gruvbox background color")

(use-package autothemer :defer t)

(use-package gruvbox-theme ; theme
  :config
  (load-theme 'gruvbox t))

(use-package display-line-numbers
  :straight (:type built-in)
  :config
  (custom-set-faces `(line-number ((t (:background ,bg-color))))
                    `(line-number-current-line ((t (:background ,bg-color)))))

  (unless IS-WINDOWS
    (setq-default display-line-numbers-type 'visual
                  display-line-numbers-width-start t ; auto count number of lines to start numbers
                  display-line-numbers-grow-only t ; don't shrink line number width
                  ))

  (global-display-line-numbers-mode))

;; Minimalistic mode-line
(setq-default mode-line-format
              '("%e"
                mode-line-front-space
                mode-line-mule-info
                mode-line-client-mode
                mode-line-modified
                mode-line-remote
                mode-line-frame-indentifcation
                " "
                mode-line-buffer-identification ; buffer name
                "  "
                vc-mode                         ; show git branch
                " "
                mode-line-modes                 ; show current mode
                " "
                mode-line-misc-info
                mode-line-end-spaces))

;; Mode-line faces
(custom-set-faces `(mode-line           ((t (:background ,bg-color :foreground "#928374"))))
                  `(mode-line-inactive  ((t (:background ,bg-color))))
                  `(mode-line-buffer-id ((t (:bold t)))))

(set-face-foreground 'vertical-border bg-color)
#+END_SRC
* Init

Tangles to init.el

Loads the file config.el on startup. Every time I exit emacs (if org has been loaded), this file tangles to config.el (defined in [[*Org][Org]] under kill-emacs-hook). If the file doesn't exist, org is loaded and the file is tangled.

#+BEGIN_SRC emacs-lisp :tangle ~/.emacs.d/init.el :results none
;;; -*- lexical-binding: t -*-
(if (version< emacs-version "27.1")
    (load-file (expand-file-name "early-init.el" user-emacs-directory)))

(defconst config-org (expand-file-name "README.org" user-emacs-directory)
  "org-mode config to tangle into config.el")

(defconst config-el  (expand-file-name "config.el" user-emacs-directory)
  "emacs-lisp tangled config file")

(unless (file-exists-p config-el) ; tangle config-org to config-el
  (require 'org)
  (org-babel-tangle-file config-org config-el))

(load-file config-el) ; load tangled config file
#+END_SRC
* Initial

The rest of this file tangles to config.el

** Settings

Mostly taken from Doom Emacs

#+BEGIN_SRC emacs-lisp :results none
;;; -*- lexical-binding: t -*-

(setq my/etc-dir (expand-file-name "etc/" user-emacs-directory)
      default-file-name-handler-alist file-name-handler-alist)

(use-package emacs
  :custom
  ;; unset file-name-handler-alist until its set again in Hooks heading (improve startup time)
  (file-name-handler-alist nil)

  ;; raise garbage collection threshold until its set again in Hooks heading
  (gc-cons-threshold most-positive-fixnum)
  (gc-cons-percentage 0.6)

  (load-prefer-newer noninteractive)
  (locale-coding-system 'utf-8)
  (message-log-max 5000) ; longer number of max messages
  (ring-bell-function 'ignore)

  ;; startup.el settings
  (inhibit-startup-screen t)
  (inhibit-startup-message t)
  (inhibit-startup-echo-area-message user-login-name)

  ;; inhibit-default-init t
  (initial-scratch-message nil)          ; empty scratch file
  (initial-major-mode 'fundamental-mode) ; start in an empty mode

  (kill-buffer-query-functions nil)
  (inhibit-compacting-font-caches t) ; inhibit font compacting
  (highlight-nonselected-windows nil)
  (ffap-machine-p-known 'reject)     ; don't ping things that look like domain names
  (bidi-inhibit-bpa t)
  (fast-but-imprecise-scrolling t)   ; faster scrolling over unfontified regions

  ;; Scrolling
  (scroll-conservatively 1000)
  (scroll-margin 4)
  (scroll-step 1)

  ;; General
  (indent-tabs-mode nil) ; tabs are converted to spaces
  (apropos-do-all t)     ; more extensive apropos searches

  ;; Disable bidirectional text rendering for performance
  (bidi-display-reordering 'left-to-right)
  (bidi-paragraph-direction 'left-to-right)
  (cursor-in-non-selected-windows nil)

  ;; Keeping ~/.emacs.d clean
  ;; (my/etc-dir                  (expand-file-name "etc/" user-emacs-directory))
  (custom-file                 (expand-file-name "custom.el"            my/etc-dir))
  (custom-theme-directory      (expand-file-name "themes/"              my/etc-dir))
  (url-configuration-directory (expand-file-name "url/"                 my/etc-dir))
  (url-cache-directory         (expand-file-name "url/"                 my/etc-dir))
  (persist--directory-location (expand-file-name "persist/"             my/etc-dir))
  (transient-history-file      (expand-file-name "transient/history.el" my/etc-dir))
  (lsp-session-file            (expand-file-name "lsp"                  my/etc-dir))
  (auto-save-list-file-prefix  (expand-file-name "auto-save/sessions"   my/etc-dir)))

(advice-add #'tty-run-terminal-initialization :override #'ignore)

;; Get rid of For information about GNU Emacs message
(advice-add #'display-startup-echo-area-message :override #'ignore)

(fset 'yes-or-no-p 'y-or-n-p) ; y or n prompt, not yes or no
#+END_SRC
** OS Specific

Optimizations for different file types from Doom emacs

#+BEGIN_SRC emacs-lisp :results none
(unless IS-WINDOWS
  (setq selection-coding-system 'utf-8))

(when IS-WINDOWS
  (setq w32-get-true-file-attributes nil
        w32-pipe-read-delay 0
        w32-pipe-buffer-size (* 64 1024)
        w32-lwindow-modifier 'super
        w32-rwindow-modifier 'super
        abbreviated-home-dir "\\ `'"))

(when (and IS-WINDOWS (null (getenv "HOME")))
  (setenv "HOME" (getenv "USERPROFILE")))

(unless IS-MAC
  (setq command-line-ns-option-alist nil))

(unless IS-LINUX
  (setq command-line-x-option-alist nil))

(when IS-LINUX
  (setq x-gtk-use-system-tooltips nil))
#+END_SRC
** Defer Incrementally

Use :defer-incrementally with packages with a lot of dependencies to incrementally load them in idle time

Taken entirely from Doom Emacs

#+BEGIN_SRC emacs-lisp :results none
;; https://github.com/hlissner/doom-emacs/blob/42a21dffddeee57d84e82a9f0b65d1b0cba2b2af/core/core.el#L353
(defvar doom-incremental-packages '(t)
  "A list of packages to load incrementally after startup. Any large packages
    here may cause noticeable pauses, so it's recommended you break them up into
    sub-packages. For example, `org' is comprised of many packages, and can be
    broken up into:
      (doom-load-packages-incrementally
       '(calendar find-func format-spec org-macs org-compat
         org-faces org-entities org-list org-pcomplete org-src
         org-footnote org-macro ob org org-clock org-agenda
         org-capture))
    This is already done by the lang/org module, however.
    If you want to disable incremental loading altogether, either remove
    `doom-load-packages-incrementally-h' from `emacs-startup-hook' or set
    `doom-incremental-first-idle-timer' to nil.")

(defvar doom-incremental-first-idle-timer 2.0
  "How long (in idle seconds) until incremental loading starts.
    Set this to nil to disable incremental loading.")

(defvar doom-incremental-idle-timer 0.75
  "How long (in idle seconds) in between incrementally loading packages.")

(defvar doom-incremental-load-immediately nil
  ;; (daemonp)
  "If non-nil, load all incrementally deferred packages immediately at startup.")

(defmacro appendq! (sym &rest lists)
  "Append LISTS to SYM in place."
  `(setq ,sym (append ,sym ,@lists)))

(defun doom-load-packages-incrementally (packages &optional now)
  "Registers PACKAGES to be loaded incrementally.
    If NOW is non-nil, load PACKAGES incrementally, in `doom-incremental-idle-timer'
    intervals."
  (if (not now)
      (appendq! doom-incremental-packages packages)
    (while packages
      (let ((req (pop packages)))
        (unless (featurep req)
          (message "Incrementally loading %s" req)
          (condition-case e
              (or (while-no-input
                    ;; If `default-directory' is a directory that doesn't exist
                    ;; or is unreadable, Emacs throws up file-missing errors, so
                    ;; we set it to a directory we know exists and is readable.
                    (let ((default-directory user-emacs-directory)
                          (gc-cons-threshold most-positive-fixnum)
                          file-name-handler-alist)
                      (require req nil t))
                    t)
                  (push req packages))
            ((error debug)
             (message "Failed to load '%s' package incrementally, because: %s"
                      req e)))
          (if (not packages)
              (message "Finished incremental loading")
            (run-with-idle-timer doom-incremental-idle-timer
                                 nil #'doom-load-packages-incrementally
                                 packages t)
            (setq packages nil)))))))

(defun doom-load-packages-incrementally-h ()
  "Begin incrementally loading packages in `doom-incremental-packages'.
    If this is a daemon session, load them all immediately instead."
  (if doom-incremental-load-immediately
      (mapc #'require (cdr doom-incremental-packages))
    (when (numberp doom-incremental-first-idle-timer)
      (run-with-idle-timer doom-incremental-first-idle-timer
                           nil #'doom-load-packages-incrementally
                           (cdr doom-incremental-packages) t))))

(add-hook 'emacs-startup-hook #'doom-load-packages-incrementally-h)

;; Adds two keywords to `use-package' to expand its lazy-loading capabilities:
;;
;;   :after-call SYMBOL|LIST
;;   :defer-incrementally SYMBOL|LIST|t
;;
;; Check out `use-package!'s documentation for more about these two.
(eval-when-compile
  (dolist (keyword '(:defer-incrementally :after-call))
    (push keyword use-package-deferring-keywords)
    (setq use-package-keywords
          (use-package-list-insert keyword use-package-keywords :after)))

  (defalias 'use-package-normalize/:defer-incrementally #'use-package-normalize-symlist)
  (defun use-package-handler/:defer-incrementally (name _keyword targets rest state)
    (use-package-concat
     `((doom-load-packages-incrementally
        ',(if (equal targets '(t))
              (list name)
            (append targets (list name)))))
     (use-package-process-keywords name rest state))))
#+END_SRC
** Keybinding/Package Management
#+BEGIN_SRC emacs-lisp :results none
(use-package general ; unified way to map keybindings; works with :general in use-package
  :demand t
  :config
  (general-create-definer my-leader-def ; SPC prefixed bindings
    :states '(normal visual motion insert emacs)
    :keymaps 'override
    :prefix "SPC"
    :non-normal-prefix "C-SPC")

  (general-create-definer my-localleader-def ; , prefixed bindings
    :states '(normal visual motion insert emacs)
    :keymaps 'override
    :prefix ","
    :non-normal-prefix "C-,")

  (my-leader-def
    "f"   '(:ignore t                    :which-key "Find")
    "fm" #'(general-describe-keybindings :which-key "list keybindings")))

(use-package minions ; hide all minor modes in modeline
  :custom
  (minions-mode-line-lighter "")
  (minions-mode-line-delimiters '(" " . ""))
  :config
  (minions-mode 1))

(use-package which-key ; show keybindings following when a prefix is pressed
  :hook (pre-command . which-key-mode)
  :defer 0.1
  :custom
  (which-key-sort-order #'which-key-prefix-then-key-order)
  (which-key-min-display-lines 6)
  (which-key-add-column-padding 1)
  (which-key-sort-uppercase-first nil)
  :general
  (my-leader-def
    "f SPC m" #'(which-key-show-top-level :which-key "keybinding")))

(use-package straight ; package manager
  :general
  (my-localleader-def
    "s"   '(:ignore t            :which-key "Straight")
    "sr" #'(straight-rebuild-all :which-key "rebuild all")
    "sf" #'(straight-fetch-all   :which-key "fetch all")
    "sp" #'(straight-pull-all    :which-key "pull all")))

(use-package straight-x
  :straight straight
  :general
  (my-localleader-def
    "sc" #'(straight-x-clean-unused-repos :which-key "clean unused")))
#+END_SRC
** Built-in Packages
#+BEGIN_SRC emacs-lisp :results none
(use-package simple
  :straight (:type built-in)
  :hook (after-init . global-visual-line-mode)
  :custom
  (idle-update-delay 1.0) ; slow down how often emacs updates its ui
  (kill-do-not-save-duplicates t)) ; no duplicates in kill ring

(use-package advice
  :straight (:type built-in)
  :defer t
  :custom (ad-redefinition-action 'accept)) ; disable warnings from legacy advice system

(use-package files
  :straight (:type built-in)
  :defer t
  :custom
  (make-backup-files nil)
  (create-lockfiles nil)
  (auto-mode-case-fold nil)
  (auto-save-default nil))

(use-package saveplace ; save location in files
  :straight (:type built-in)
  :hook (pre-command . save-place-mode)
  :custom
  (save-place-file (expand-file-name "places" my/etc-dir)))

(use-package whitespace
  :straight (:type built-in)
  :hook (before-save . whitespace-cleanup)) ; clean unnecessary whitespace before save

(use-package savehist ; save command history
  :straight (:type built-in)
  :hook (pre-command . savehist-mode)
  :custom
  (savehist-file (expand-file-name "savehist" my/etc-dir))
  (history-length 500)
  (history-delete-duplicates t)
  (savehist-save-minibuffer-history t))

(use-package recentf
  :straight (:type built-in)
  :defer-incrementally (easymenu tree-widget timer)
  :hook (pre-command . recentf-mode)
  :custom
  (recentf-auto-cleanup 'never)
  (recentf-save-file (expand-file-name "recentf" my/etc-dir))
  (recentf-max-saved-items 200))

(when (or IS-LINUX IS-MAC)
  (use-package flyspell ; spellcheck
    :straight (:type built-in)
    :hook (prog-mode . flyspell-prog-mode)
    :general
    ('(normal insert)
     "M-f" #'(flyspell-auto-correct-word :which-key "fix word"))))

(use-package bookmark
  :straight (:type built-in)
  :defer t
  :custom
  (bookmark-default-file (expand-file-name "bookarks" my/etc-dir)))

(use-package calc
  :straight (:type built-in)
  :general
  (my-leader-def
    "o"   '(:ignore t :which-key "Open")
    "oc" #'(calc      :which-key "calc")))

(use-package desktop ; save sessions to a file
  :defer t
  :straight (:type built-in)
  :custom
  (desktop-load-locked-desktop t) ; ignore desktop-lock files
  (desktop-dirname (expand-file-name "desktop/" my/etc-dir))
  (desktop-path (list desktop-dirname))
  (desktop-save-mode 1)
  (desktop-base-file-name "emacs.desktop"))

(use-package project
  :straight (:type built-in)
  :general
  (my-leader-def
    "p"   '(:ignore t         :which-key "Project")
    "pf" #'(project-find-file :which-key "find file")))
#+END_SRC
** Keybindings
#+BEGIN_SRC emacs-lisp :results none
(use-package emacs ; initial keybindings of built-in functions
  :general
  (my-localleader-def
    "c" (general-simulate-key "C-c" :which-key "+Mode specific maps"))

  (my-leader-def
    "h"         (general-simulate-key "C-h" :which-key "+Help")

    ;; Windows
    ";"       #'(shell-command              :which-key "shell command")
    "w"         (general-simulate-key "C-w" :which-key "+Windows") ; window command

    ;; Buffers
    "b"        '(:ignore t                 :which-key "Buffers")
    "bs"      #'(save-buffer               :which-key "write file")
    "bd"      #'(kill-this-buffer          :which-key "delete buffer")
    "bq"      #'(my/save-and-kill-buffer   :which-key "save and kill buffer")
    "b SPC d" #'(my/kill-window-and-buffer :which-key "kill window and buffer")
    "br"        (lambda () (interactive)
                  (revert-buffer t t)      :which-key "revert-buffer")
    "bn"      #'(next-buffer               :which-key "next buffer")
    "bp"      #'(previous-buffer           :which-key "previous buffer")

    ;; Eval elisp
    "e"        '(:ignore t                    :which-key "Elisp")
    "er"      #'(eval-region                  :which-key "execute elisp region")
    "es"      #'(eval-last-sexp               :which-key "execute elisp sexp")
    "ee"      #'(eval-expression              :which-key "evaluate elisp expression")
    "eb"      #'(eval-buffer                  :which-key "evaluate elisp buffer")
    "ef"      #'(eval-defun                   :which-key "evaluate elisp defun")
    "'"         (general-simulate-key "C-c '" :which-key "open src block")

    ;; Find specific files
    "of" '(:ignore t :which-key "File")
    "ofr" (lambda () (interactive)
            (tab-bar-switch-to-tab "org")
            (find-file "~/.emacs.d/README.org") :which-key "config")

    "oft" (lambda () (interactive)
            (tab-bar-switch-to-tab "org")
            (find-file "~/org/todo.org") :which-key "todo")

    "ofc" (lambda () (interactive)
            (counsel-find-file "~/code/") :which-key "todo"))

  ('normal
   "gs" #'(my/split-line-below         :which-key "split line below")
   "gS" #'(my/split-line-above         :which-key "split line above")
   "]b" #'(next-buffer                 :which-key "next buffer")
   "[b" #'(previous-buffer             :which-key "previous buffer")
   "[n"   (lambda () (interactive) (display-line-numbers-mode -1))
   "]n"   (lambda () (interactive) (display-line-numbers-mode +1))
   "g C-l" #'(end-of-visual-line       :which-key "end of visual line")
   "g C-h" #'(beginning-of-visual-line :which-key "beginning of visual line"))

  ;; TODO change for if mac vs linux
  ('(normal insert)
   "M-/" #'(comment-line :which-key "comment"))

  ('visual
   "M-/" #'(comment-dwim :which-key "comment"))


  ('(normal insert)
   :prefix "C-c"
   "SPC" (general-simulate-key "C-c C-c"))

  ('insert
   "C-y" #'yank ; otherwise is overridden by evil
   "C-e" #'end-of-line
   "C-a" #'beginning-of-line
   "C-w" (general-simulate-key "M-DEL"))

  ('insert '(prog-mode-map text-mode-map)
           "C-w" #'evil-delete-backward-word)
  :config
  (which-key-add-key-based-replacements
    "SPC br" "revert buffer"
    "SPC omi" "matlab inferior"
    "[n" "toggle line numbers off"
    "]n" "toggle line numbers on"))
#+END_SRC
** Hooks
#+BEGIN_SRC emacs-lisp :results none
(add-hook 'after-init-hook ; show startup time
          (lambda ()
            "show the startup time"
            (when (require 'time-date nil t)
              (message "Emacs init time: %.2f seconds."
                       (time-to-seconds (time-since emacs-load-start-time))))))

(add-hook 'emacs-startup-hook ; reset garbage collection settings and file-name-handler-alist
          (lambda ()
            "raise the garbage collection threshold to defer garbage collection
               and unset file-name-handler-alist"
            (setq gc-cons-threshold 16777216
                  gc-cons-percentage 0.1
                  file-name-handler-alist default-file-name-handler-alist)))

;; Raise gc threshold while minibuffer is active to not slow down ivy
(defun doom-defer-garbage-collection-h ()
  "Defer garbage collection by setting it to the largest possible number"
  (setq gc-cons-threshold most-positive-fixnum))

(defun doom-restore-garbage-collection-h ()
  "Restore the garbage collection threshold"
  (run-at-time
   1 nil (lambda () (setq gc-cons-threshold 16777216))))

;; decrease garbage collection when using minibuffer
(add-hook 'minibuffer-setup-hook #'doom-defer-garbage-collection-h)
(add-hook 'minibuffer-exit-hook  #'doom-restore-garbage-collection-h)
#+END_SRC
** Functions
*** Miscellaneous
#+BEGIN_SRC emacs-lisp :results none
;;;###autoload
(defun my/save-and-kill-buffer ()
  "save and kill buffer"
  (interactive)
  (save-buffer)
  (kill-this-buffer))

;;;###autoload
(defun my/split-line-below ()
  "split the line below at point"
  (interactive)
  (newline)
  (indent-according-to-mode))

;;;###autoload
(defun my/split-line-above ()
  "split the line above at point"
  (interactive)
  (my/split-line-below)
  (move-text-up))

;;;###autoload
(defun my/kill-window-and-buffer ()
  "kill window and buffer"
  (interactive)
  (kill-this-buffer)
  (evil-quit))

;;;###autoload
(defun my/append-semicolon()
  "append a semicolon to the end of the line"
  (interactive)
  (save-excursion
    (call-interactively 'move-end-of-line)
    (insert ";")))
#+END_SRC
*** Format

Entirely from Doom Emacs

#+BEGIN_SRC emacs-lisp :results none
;;;###autoload
(defun +format--org-region (beg end)
  "Reformat the region within BEG and END.
     If nil, BEG and/or END will default to the boundaries of the src block at point."
  (let ((element (org-element-at-point)))
    (save-excursion
      (let* ((block-beg (save-excursion
                          (goto-char (org-babel-where-is-src-block-head element))
                          (line-beginning-position 2)))
             (block-end (save-excursion
                          (goto-char (org-element-property :end element))
                          (skip-chars-backward " \t\n")
                          (line-beginning-position)))
             (beg (if beg (max beg block-beg) block-beg))
             (end (if end (min end block-end) block-end))
             (lang (org-element-property :language element))
             (major-mode (org-src-get-lang-mode lang)))
        (if (eq major-mode 'org-mode)
            (user-error "Cannot reformat an org src block in org-mode")
          (+format/region beg end))))))

;;;###autoload
(defun +format/buffer ()
  "Reformat the current buffer using LSP or `format-all-buffer'."
  (interactive)
  (save-excursion
    (if (and (eq major-mode 'org-mode)
             (org-in-src-block-p t))
        (+format--org-region nil nil)
      (call-interactively
       (cond ((and +format-with-lsp
                   (bound-and-true-p lsp-mode)
                   (lsp-feature? "textDocument/formatting"))
              #'lsp-format-buffer)
             (#'format-all-buffer))))))

;;;###autoload
(defun +format/region (beg end)
  "Runs the active formatter on the lines within BEG and END.
   WARNING: this may not work everywhere. It will throw errors if the region
   contains a syntax error in isolation. It is mostly useful for formatting
   snippets or single lines."
  (interactive "rP")
  (if (and (eq major-mode 'org-mode)
           (org-in-src-block-p t))
      (+format--org-region beg end)
    (cond ((and +format-with-lsp
                (bound-and-true-p lsp-mode)
                (lsp-feature? "textDocument/rangeFormatting"))
           (call-interactively #'lsp-format-region))
          ((and +format-with-lsp
                (bound-and-true-p eglot--managed-mode)
                (eglot--server-capable :documentRangeFormattingProvider))
           (call-interactively #'eglot-format))
          ((save-restriction
             (narrow-to-region beg end)
             (let ((+format-region-p t))
               (+format/buffer)))))))
#+END_SRC
* Evil Mode
** Evil
#+BEGIN_SRC emacs-lisp :results none
(use-package evil ; vim bindings in emacs
  :demand t
  :custom
  (evil-want-C-u-scroll t)
  (evil-want-Y-yank-to-eol t)
  (evil-split-window-below t)
  (evil-vsplit-window-right t)
  (evil-search-wrap t)
  (evil-want-keybinding nil)
  (evil-search-module 'isearch) ; swiper searches swap n and N if this isn't set
  (evil-want-fine-undo 'fine)       ; save inserts as undo units more often
  (evil-ex-search-persistent-highlight nil)
  (evil-ex-substitute-highlight-all nil)
  (evil-ex-search-persist-highlight nil)
  :general
  ('normal ; navigate wrapped lines like normal lines, works great with relative line numbers
   [remap evil-next-line]          #'evil-next-visual-line
   [remap evil-previous-line]      #'evil-previous-visual-line
   [remap evil-ex-search-forward]  #'isearch-forward
   [remap evil-ex-search-backward] #'isearch-backward
   "zr" #'(evil-open-folds  :which-key "open folds recursively")
   "zm" #'(evil-close-folds :which-key "close folds recursively")
   "gm" (general-simulate-key "@@" :which-key "run last macro") ; last macro
   "C-M-d" #'scroll-other-window
   "C-M-u" #'scroll-other-window-down)

  ('evil-ex-completion-map "C-g" 'exit-minibuffer) ; use ; to complete : vim commands
  ('evil-ex-completion-map ";" 'exit-minibuffer) ; use ; to complete : vim commands

  ('(normal visual motion)
   ";" #'evil-ex ; switch ; and :
   "H" #'evil-first-non-blank
   "L" #'evil-end-of-line)

  (my-leader-def
    "bS" #'(evil-write-all                     :which-key "write all buffers")
    "bl" #'(evil-switch-to-windows-last-buffer :which-key "last buffer")
    "bo" #'(evil-buffer-new                    :which-key "new buffer"))

  ('evil-window-map
   "SPC h" #'(evil-window-move-far-left    :which-key "move window left")
   "SPC j" #'(evil-window-move-very-bottom :which-key "move window down")
   "SPC k" #'(evil-window-move-very-top    :which-key "move window up")
   "SPC l" #'(evil-window-move-far-right   :which-key "move window right")
   "d"     #'(evil-quit                    :which-key "delete window")
   "q"     #'(evil-save-modified-and-close :which-key "quit and save window")
   "SPC q" #'(save-buffers-kill-emacs      :which-key "save buffers & quit emacs")
   "a"       (lambda () (interactive)
               (evil-window-increase-width 5))
   "x"       (lambda () (interactive)
               (evil-window-decrease-width 5)))

  ('(normal insert)
   "C-l" #'(evil-ex-nohighlight :which-key "clear highlight"))
  :config
  (evil-mode))
#+END_SRC
** Evil-Collection
#+BEGIN_SRC emacs-lisp :results none
(use-package evil-collection ; evil bindings for many modes
  :defer t
  :custom
  (evil-collection-want-unimpaired-p t)
  (evil-collection-setup-minibuffer t)
  (evil-collection-mode-list
   '(minibuffer
     ivy
     dired
     eshell
     (pdf pdf-tools)
     magit)))
#+END_SRC
** Extra operators/motions
#+BEGIN_SRC emacs-lisp :results none
(use-package evil-snipe ; 2 character searches with s (ala vim-sneak)
  :hook (pre-command . evil-snipe-mode)
  :custom
  (evil-snipe-show-prompt nil)
  (evil-snipe-skip-leading-whitespace nil)
  :general
  ('normal
   [remap evil-find-char] #'evil-snipe-f
   [remap evil-find-char-backward] #'evil-snipe-F)

  ('motion
   ":"   #'(evil-snipe-repeat         :which-key "repeat last search")
   "M-," #'(evil-snipe-repeat-reverse :which-key "repeat last search backwards")))

(use-package evil-surround ; s as an operator for surrounding
  :hook (pre-command . evil-surround-mode))

(use-package evil-embrace ; custom surround pairs
  :after evil-surround
  :config
  (setq evil-embrace-show-help-p nil)
  (add-hook 'org-mode-hook 'embrace-org-mode-hook)
  (evil-embrace-enable-evil-surround-integration)
  (add-hook 'org-mode-hook
            (lambda ()
              (dolist (var '((?s "#+BEGIN_SRC" . "#+END_SRC")
                             (?$ "$" . "$")))
                (embrace-add-pair (car var) (cadr var) (cddr var))))))

(use-package evil-nerd-commenter ; comment lines like in tpope's commentary
  :general
  ('normal
   "gc" #'(evilnc-comment-operator          :which-key "comment")
   "gy" #'(evilnc-copy-and-comment-operator :which-key "copy and comment")))

(use-package evil-numbers ; increment/decrement numbers w/ vim keys
  :general
  ('normal override
           "C-a" #'(evil-numbers/inc-at-pt :which-key "increment number")
           "C-x" #'(evil-numbers/dec-at-pt :which-key "decrement number")))

(use-package evil-lion ; gl as an operator to left-align, gL to right-align
  :hook ((prog-mode text-mode) . evil-lion-mode))

(use-package evil-matchit ; navigate matching blocks of code with %
  :hook (find-file . evil-matchit-mode)
  :general
  ('motion
   "%" #'(evilmi-jump-items :which-key "jump to matching pair")))

(use-package evil-exchange ; exchange text selected with gx
  :general
  ('(normal visual)
   "gx" #'(evil-exchange        :which-key "exchange operator")
   "gX" #'(evil-exchange-cancel :which-key "cancel exchange")))

(use-package evil-textobj-anyblock
  :general
  ('evil-inner-text-objects-map "c" #'(evil-textobj-anyblock-inner-block :which-key "nearest text object"))
  ('evil-outer-text-objects-map "c" #'(evil-textobj-anyblock-a-block     :which-key "nearest text object")))

(use-package evil-args ; argument text object: ex. arg1,ar|g2,arg2 - can delete with daa
  :general
  ('evil-inner-text-objects-map "a" #'(evil-inner-arg :which-key "inner arg"))
  ('evil-outer-text-objects-map "a" #'(evil-outer-arg :which-key "outer arg")))

(use-package evil-indent-plus ; indent level text object
  :general
  ('evil-inner-text-objects-map
   "i" #'(evil-indent-plus-i-indent         :which-key "indent level")
   "I" #'(evil-indent-plus-i-indent-up      :which-key "indent level and up")
   "J" #'(evil-indent-plus-i-indent-up-down :which-key "indent level up and down"))

  ('evil-outer-text-objects-map
   "i" #'(evil-indent-plus-a-indent         :which-key "indent level")
   "I" #'(evil-indent-plus-a-indent-up      :which-key "indent level and up")
   "J" #'(evil-indent-plus-a-indent-up-down :which-key "indent level up and down")))
#+END_SRC
** Miscellaneous
#+BEGIN_SRC emacs-lisp :results none
(use-package evil-escape ; jk to leave insert mode
  :hook (pre-command . evil-escape-mode)
  :custom
  (evil-escape-key-sequence "jk")
  (evil-escape-delay 0.25)
  (evil-escape-excluded-major-modes '(org-agenda-mode))
  (evil-escape-excluded-states '(normal visual emacs)))

(use-package origami ; code folding
  :hook (prog-mode . origami-mode)
  :general
  ('normal origami-mode-map
           "zc" #'(origami-close-node-recursively :which-key "close fold recursively")
           "zo" #'(origami-open-node-recursively  :which-key "open fold recursively")
           "zj" #'(origami-next-fold              :which-key "next fold")
           "zk" #'(origami-previous-fold          :which-key "previous fold")
           "zm" #'(origami-close-all-nodes        :which-key "close all folds recursively")
           "zr" #'(origami-open-all-nodes         :which-key "open all folds recursively")))
#+END_SRC
* Completion
** Ivy
#+BEGIN_SRC emacs-lisp :results none
(use-package swiper ; ivy for searching through buffers
  :custom
  (swiper-use-visual-line nil)
  (swiper-use-visual-line-p (lambda (a) nil))
  :general
  (my-leader-def
    "/"  #'swiper-isearch
    "?"  #'swiper-isearch-backward
    "fb" #'(swiper-multi :which-key "swiper in buffer")
    "fB" #'(swiper-all   :which-key "swiper in all buffers")))

(use-package ivy ; narrowing framework
  :defer 0.1
  :hook (pre-command . ivy-mode)
  :general
  ('(normal insert) ivy-minibuffer-map
   ";"   #'exit-minibuffer
   "C-j" #'ivy-next-line
   "C-k" #'ivy-previous-line)

  ('normal ivy-minibuffer-map
           "q" #'minibuffer-keyboard-quit)

  ('(normal insert) minibuffer-local-mode-map
   ";" #'exit-minibuffer)

  ('(normal insert) minibuffer-inactive-mode-map
   ";" #'ivy-done)
  :custom
  (ivy-initial-inputs-alist nil) ; no initial ^, let flx do all the sorting work
  :config
  (setq ivy-re-builders-alist '((swiper-isearch        . ivy--regex-plus)
                                (counsel-rg            . ivy--regex-plus)
                                (counsel-projectile-rg . ivy-regex-plus)
                                (t                     . ivy--regex-fuzzy)))
  (evil-collection-init 'minibuffer)
  (evil-collection-init 'ivy))

(use-package counsel ; ivy support for many functions
  :custom
  (counsel-describe-function-function #'helpful-callable)
  (counsel-describe-variable-function #'helpful-variable)
  :general
  (my-leader-def
    "."       #'(counsel-find-file :which-key "file in directory")
    "SPC"     #'(ivy-switch-buffer :which-key "switch buffer")
    "fr"      #'(counsel-recentf   :which-key "find recent files")
    "fj"      #'(counsel-imenu     :which-key "imenu")
    "gff"     #'(counsel-git       :which-key "git files")
    "ps"      #'(counsel-git-grep  :which-key "git grep")
    "f SPC f" #'(counsel-file-jump :which-key "file")
    "ff"      #'(counsel-fzf       :which-key "fzf")
    "fi"       '(:ignore t         :which-key "find in directory")
    "fih"       (lambda () (interactive) (counsel-file-jump "" "~"))
    "fis"       (lambda () (interactive) (counsel-file-jump "" "~/school"))
    "fic"       (lambda () (interactive) (counsel-file-jump "" "~/code"))
    "fio"       (lambda () (interactive) (counsel-file-jump "" "~/org"))
    "fie"       (lambda () (interactive) (counsel-file-jump "" "~/.emacs.d"))
    "fid"       (lambda () (interactive) (counsel-file-jump "" "~/Downloads"))
    "fd"      #'(counsel-dired     :which-key "directory")
    "p SPC s" #'(counsel-rg        :which-key "ripgrep")

    "ofo" (lambda () (interactive)
            (tab-bar-switch-to-tab "org")
            (counsel-find-file "~/org") :which-key "org")

    "ofs" (lambda () (interactive)
            (counsel-find-file "~/school/spring2022") :which-key "school"))


  (my-localleader-def
    "x" #'(counsel-M-x :which-key "M-x"))

  ('(normal insert) org-mode-map
   :prefix "C-c"
   "f"  #'(counsel-org-goto-all :which-key "find org headline"))
  :config
  (which-key-add-key-based-replacements
    "SPC fih" "find in ~"
    "SPC fis" "find in school"
    "SPC fin" "find in notes"
    "SPC fic" "find in code"
    "SPC fio" "find in org"
    "SPC fie" "find in dotemacs"
    "SPC fid" "find in downloads")
  (counsel-mode))

(use-package amx ; show recently used commands
  :hook (pre-command . amx-mode)
  :custom
  (amx-save-file (expand-file-name "amx-history" my/etc-dir))
  (amx-history-length 50))

(use-package flx :defer t)
#+END_SRC
** Yasnippet
#+BEGIN_SRC emacs-lisp :results none
(use-package yasnippet ; snippets
  :defer 0.2
  :defer-incrementally (eldoc easymenu help-mode)
  :custom
  (yas-snippet-dirs '("~/.emacs.d/snippets" "~/org/snippets"))
  :general
  (my-leader-def
    "s"   '(:ignore t           :which-key "Yasnippet")
    "si" #'(yas-insert-snippet  :which-key "insert")
    "sn" #'(yas-new-snippet     :which-key "new")
    "sl" #'(yas-describe-tables :which-key "list")
    "sr" #'(yas-reload-all      :which-key "reload"))
  :config
  ;; Latex-mode snippets in org
  (add-hook 'org-mode-hook (lambda ()
                             (yas-activate-extra-mode 'latex-mode)))

  (yas-global-mode 1))
#+END_SRC
** Company
#+BEGIN_SRC emacs-lisp :results none
(use-package company ; autocomplete
  :defer 0.1
  :custom
  (company-idle-delay 0.01)
  (company-require-match 'never)
  (company-show-numbers t)
  (company-dabbrev-other-buffers nil)
  (company-tooltip-offset-display nil)
  (company-dabbrev-ignore-case nil)

  ;; global default for the backend, buffer-local backends will be set based on filetype
  (company-backends '(company-capf
                      company-files
                      company-dabbrev-code
                      company-yasnippet))
  :general
  ('insert company-mode-map
           "C-j" #'company-manual-begin)

  ('company-active-map "C-w" nil ; don't override evil C-w
                       "C-j"      #'company-select-next-or-abort
                       "C-k"      #'company-select-previous-or-abort
                       "<tab>"    #'company-complete-selection
                       "0"          (lambda () (interactive) (company-complete-number 10))
                       "RET"      #'newline
                       "<return>" #'newline
                       ";"        #'company-complete-selection) ; choose a completion with ; instead of tab


  :config
  ;; complete suggestion based on the number
  (let ((map company-active-map))
    (mapc (lambda (x) (define-key map (format "%d" x)
                        `(lambda () (interactive) (company-complete-number ,x))))
          (number-sequence 1 9)))
  (global-company-mode))

(use-package company-flx ; fuzzy sorting for company completion options with company-capf
  :hook (company-mode . company-flx-mode))
#+END_SRC
* Version Control
#+BEGIN_SRC emacs-lisp :results none
(use-package git-commit    :defer t)
(use-package transient     :defer t)
(use-package magit-section :defer t)

(use-package magit ; git client
  :defer-incrementally
  (evil-collection magit-section dash f s with-editor git-commit package eieio lv transient)
  :custom
  (magit-save-repository-buffers nil)
  (magit-no-confirm '(stage-all-changes))
  :hook
  (git-commit-mode . evil-insert-state)
  :general
  (my-leader-def
    "g"    '(:ignore t                   :which-key "Git")
    "gs"  #'(magit-status                :which-key "status")
    "gb"  #'(magit-branch-checkout       :which-key "checkout branch")
    "gd"  #'(magit-file-delete           :which-key "delete file")
    "gF"  #'(magit-fetch                 :which-key "fetch")
    "gn"   '(:ignore t                   :which-key "New")
    "gnb" #'(magit-branch-and-checkout   :which-key "branch")
    "gnf" #'(magit-commit-fixup          :which-key "fixup commit")
    "gi"  #'(magit-init                  :which-key "init")
    "gl"  #'(magit-log                   :which-key "log")
    "gf"   '(:ignore t                   :which-key "Find")
    "gfc" #'(magit-show-commit           :which-key "show commit")
    "gfg" #'(magit-find-git-config-file  :which-key "git config file")
    "gc"  #'(+magit/stage-all-and-commit :which-key "stage all and commit"))
  :config
  (evil-collection-init 'magit)

  (setq evil-collection-magit-state 'normal
        evil-collection-magit-use-z-for-folds t
        magit-auto-revert-mode nil))
#+END_SRC
** Functions
#+BEGIN_SRC emacs-lisp :results none
;;;###autoload
(defun +magit/stage-all-and-commit ()
  "stage all files and commit"
  (interactive)
  (save-buffer (current-buffer))
  (magit-stage-modified)
  (magit-commit-create)
  (magit-push))
#+END_SRC
* LSP-Related
#+BEGIN_SRC emacs-lisp :results none
;; TODO go to symbol
;; TODO popups for code completion
(use-package lsp-mode ; LSP
  :hook
  (js2-mode . lsp-deferred)
  :custom
  ;; Disable slow features
  (lsp-enable-file-watchers nil)
  (lsp-enable-folding nil)
  (lsp-enable-text-document-color nil)
  (lsp-headerline-breadcrumb-enable nil)

  ;; Clean modeline
  (lsp-modeline-diagnostics-enable nil)
  (lsp-modeline-code-actions-enable nil)
  (lsp-modeline-workspace-status-enable nil)

  ;; Don't modify our code w/o permission
  (lsp-enable-indentation nil)
  (lsp-enable-on-type-formatting nil)
  (lsp-clients-typescript-server-args '("--stdio"))
  :general
  ('normal
   [remap evil-goto-definition] #'lsp-find-definition)
  (my-localleader-def
    "g"   '(:ignore t                   :which-key "Miscellaneous")
    "h"  #'(lsp-describe-thing-at-point :which-key "view doc")
    "gr" #'(lsp-rename                  :which-key "rename with lsp")))

(use-package lsp-ui
  :defer t
  :custom
  (lsp-ui-doc-enable nil)
  (lsp-ui-doc-show-with-cursor t)
  (lsp-ui-doc-position 'bottom)
  :hook (lsp-mode . lsp-ui-mode))

(use-package lsp-ivy
  :defer t
  :general
  (my-localleader-def
    "t" (lambda () (interactive)
          (lsp-ivy-workspace-symbol 'symbol-at-point)
          :which-key "view usages")))

(use-package flycheck ; code syntax checking
  :hook (prog-mode . flycheck-mode)
  :custom
  (flycheck-emacs-lisp-load-path 'inherit)
  (flycheck-display-errors-delay 0.25)
  (flycheck-disabled-checkers '(emacs-lisp-checkdoc))
  :general
  ('normal
   "[q" #'(flycheck-previous-error :which-key "previous error")
   "]q" #'(flycheck-next-error :which-key "next error"))

  (my-leader-def
    "fe" #'(flycheck-list-errors :which-key "list errors"))
  :config
  (flycheck-add-mode 'javascript-eslint 'web-mode))

(use-package lsp-modeline
  :disabled t)

(use-package xref
  :commands xref-find-references xref-auto-jump-first-definition)
#+END_SRC
* UI
#+BEGIN_SRC emacs-lisp :results none
(use-package rainbow-delimiters
  :hook (prog-mode . rainbow-delimiters-mode))

(use-package highlight-numbers
  :hook (find-file . highlight-numbers-mode))

(use-package hl-todo
  :hook (prog-mode . hl-todo-mode))

(use-package highlight-escape-sequences
  :hook (prog-mode . hes-mode))

(use-package paren ; show matching parentheses
  :straight (:type built-in)
  :hook ((prog-mode text-mode) . show-paren-mode)
  :custom
  (show-paren-when-point-inside-paren t))

(use-package diff-hl
  :defer 0.5
  :config
  (global-diff-hl-mode)
  :general
  ('normal
   "]h" #'diff-hl-next-hunk
   "[h" #'diff-hl-previous-hunk))
#+END_SRC
* Org
** Org
#+BEGIN_SRC emacs-lisp :results none
(use-package org
  :straight (:type built-in)
  :hook
  (kill-emacs . +org/tangle-config)
  (org-tab-first . yas-expand)

  :defer-incrementally
  (calendar find-func format-spec org-macs org-compat
            org-faces org-entities org-list org-pcomplete org-src
            org-footnote org-macro ob org org-clock org-agenda
            org-capture evil-org flyspell)
  :custom
  ;; Directories
  (org-id-locations-file (expand-file-name ".org-id-locations" my/etc-dir))
  (org-agenda-files '("~/org"))

  (org-directory "~/org")
  (org-default-notes-file (expand-file-name "notes.org/" org-directory ))

  ;; General settings
  (org-list-allow-alphabetical t)
  (org-startup-folded t)
  (org-fontify-done-headline t)
  (org-M-RET-may-split-line nil)

  ;; (org-log-done 'time)
  (org-tag-alist '(("school" . ?s) ("personal" . ?p) ("drill" . ?d) ("TOC" . ?t)))

  ;; Latex exports
  (org-export-backends '(html latex md))
  (org-latex-listings 'minted) ; syntax-highlighted code blocks
  ;; (org-latex-packages-alist '(("margin=0.5in" "geometry" nil) (nil "minted" "color")))
  (org-latex-pdf-process ; required to use minted
   '("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"))
  (org-latex-minted-options '(("linenos" "true") ; line numbers in expored src blocks
                              ("frame" "lines")
                              ("style" "emacs")))
  :general
  ('(normal insert) org-mode-map
   ;; TODOS with M-;, headlines with C-;, add shift to do those above
   "C-M-;"        #'+org/insert-subheading
   "C-;"          #'+org/insert-heading
   "C-:"          #'+org/insert-heading-above
   "M-;"          #'+org/insert-todo
   "M-:"          #'+org/insert-todo-above
   "M-<return>"   #'+org/insert-todo
   "M-S-<return>" #'+org/insert-todo-above
   "C-<return>"   #'+org/insert-heading
   "C-S-<return>"   #'+org/insert-heading-above

   ;; Vim keys > arrow keys
   "M-h"   #'org-metaleft
   "M-j"   #'org-metadown
   "M-k"   #'org-metaup
   "M-l"   #'org-metaright

   "M-H"   #'org-shiftleft
   "M-J"   #'org-shiftdown
   "M-K"   #'org-shiftup
   "M-L"   #'org-shiftright

   "C-M-h" #'org-shiftmetaleft
   "C-M-j" #'org-shiftmetadown
   "C-M-k" #'org-shiftmetaup
   "C-M-l" #'org-shiftmetaright

   "C-S-h" #'org-shiftcontrolleft
   "C-S-j" #'org-shiftcontroldown
   "C-S-k" #'org-shiftcontrolup
   "C-S-l" #'org-shiftcontrolright)

  ('(normal insert) :prefix "C-c"
   "e"  #'(org-latex-export-to-pdf     :which-key "export to pdf")
   ",v" #'(org-redisplay-inline-images :which-key "redisplay inline images")
   "v"  #'(org-toggle-inline-images    :which-key "toggle inline images")
   "t"  #'(org-todo                    :which-key "todo")
   "s"  #'(org-sort                    :which-key "sort")
   ",s" #'(org-schedule                :which-key "schedule")
   "d"  #'(org-deadline                :which-key "deadline")
   "q"  #'(org-set-tags-command        :which-key "add tags")
   "p"  #'(org-latex-preview           :which-key "preview latex")
   ",p" #'(org-set-property            :which-key "set property")
   ",t" (lambda () (interactive)
          (+org/tangle-config)
          (load-file config-el))
   )

  ('normal org-mode-map
           "zo" #'outline-show-subtree
           "zk" #'org-backward-element
           "zj" #'org-forward-element)

  ('insert org-mode-map
           "S-RET" (lambda () (interactive)
                     (org-return)
                     (+org-indent)))

  ;; Vim keys calendar maps
  ('org-read-date-minibuffer-local-map
   ";" #'exit-minibuffer
   "M-h" (lambda () (interactive) (org-eval-in-calendar '(calendar-backward-day 1)))
   "M-j" (lambda () (interactive) (org-eval-in-calendar '(calendar-forward-week 1)))
   "M-k" (lambda () (interactive) (org-eval-in-calendar '(calendar-backward-week 1)))
   "M-l" (lambda () (interactive) (org-eval-in-calendar '(calendar-forward-day 1)))
   "M-H" (lambda () (interactive) (org-eval-in-calendar '(calendar-backward-month 1)))
   "M-J" (lambda () (interactive) (org-eval-in-calendar '(calendar-forward-year 1)))
   "M-K" (lambda () (interactive) (org-eval-in-calendar '(calendar-backward-year 1)))
   "M-L" (lambda () (interactive) (org-eval-in-calendar '(calendar-forward-month 1))))
  :config
  ;; Don't execute org-babel blocks on export
  (add-to-list 'org-babel-default-header-args
               '(:eval . "never-export"))

  ;; Org-mode local settings
  (add-hook 'org-mode-hook (lambda ()
                             (add-to-list 'org-modules 'habits)))

  ;; No unnecessary background highlighting
  (custom-set-faces
   `(org-block            ((t (:background ,bg-color))))
   `(org-block-begin-line ((t (:background ,bg-color))))
   `(org-block-end-line   ((t (:background ,bg-color))))
   `(org-level-1          ((t (:background ,bg-color))))
   `(org-quote            ((t (:background ,bg-color))))
   `(org-headline-done    ((t (:strike-through t :foreground "#7C6f64"))))
   `(org-done             ((t (:foreground "#7C6f64")))))

  (setq org-todo-keyword-faces '(("WAIT" . (:foreground "#7C6f64" :weight bold))
                                 ("OPT." . (:foreground "#fe8019" :weight bold)))

        org-todo-keywords '((sequence "TODO(t)" "WAIT(w)"
                                      "OPT.(o)" "WIP.(p)" "|" "DONE")))

  (plist-put org-format-latex-options :scale 1.75)) ; Larger inline org latex
#+END_SRC
** Org built-ins
#+BEGIN_SRC emacs-lisp :results none
(use-package org-agenda
  :straight (:type built-in)
  :custom
  (org-agenda-span 14)              ; show 14 days
  (org-agenda-start-on-weekday nil) ; start on today
  :general
  (my-leader-def
    "oa" #'org-agenda-list
    "ova" (lambda () (interactive)
            (evil-window-vsplit)
            (org-agenda-list)))
  :config
  (require 'evil-org-agenda)
  (evil-org-agenda-set-keys)
  :config
  (which-key-add-key-based-replacements
    "SPC oa" "agenda"))

(use-package org-src
  :straight (:type built-in)
  :defer t
  :custom
  (org-edit-src-content-indentation 0) ; leading spaces before the #+begin line
  (org-src-tab-acts-natively nil)
  (org-src-preserve-indentation t)     ; don't preserve leading whitespace on export
  (org-adapt-indentation nil)          ; don't indent under headlines
  (org-src-window-setup 'current-window)
  :general
  ('insert org-mode-map
           "<backtab>" '+org-indent))

(use-package ob ; org babel
  :straight (:type built-in)
  :defer t
  :custom
  (org-confirm-babel-evaluate nil)
  :general
  ('(normal insert) org-mode-map
   :prefix "C-c"
   "b"  #'(org-babel-tangle :which-key "tangle file")))

(use-package ox ; org exports
  :straight (:type built-in)
  :general
  ('(normal insert) org-mode-map
   :prefix "C-c"
   "e" #'(org-export-dispatch :which-key "export")))

(use-package org-capture
  :straight (:type built-in)
  :custom
  (org-capture-templates
   '(("l" "Life TODO entry"
      entry (file+headline "~/org/todo.org" "Life")
      "*     TODO %?\n %i\n" :prepend t)

     ("e" "Emacs TODO entry"
      entry (file+headline "~/org/todo.org" "Emacs")
      "*     TODO %?\n %i\n" :prepend t)

     ("t" "today TODO entry"
      entry (file+headline "~/org/todo.org" "Today")
      "*     TODO %?\n %i\n" :prepend t)

     ("s" "school TODO"
      entry (file+headline "~/org/todo.org" "School")
      "*     TODO %?\n %i\n" :prepend t)

     ("d" "org drill"
      entry (file+headline "~/org/notes.org" "Miscellaneous")
      "* %? :drill:" :prepend t)))
  :general
  (my-leader-def
    "on" #'(org-capture :which-key "org capture")))

(use-package ol ; org links
  :straight (:type built-in)
  :general
  ('(normal insert) org-mode-map
   :prefix "C-c"
   ",l" #'(org-insert-link :which-key "insert link"))
  ('override
   :prefix "C-c"
   "l"  #'(org-store-link  :which-key "store link")))

;; autoload org babel functions for specific languages
(use-package ob-haskell
  :straight (:type built-in)
  :commands org-babel-execute:haskell)

(use-package ob-shell
  :straight (:type built-in)
  :commands org-babel-execute:sh)

(use-package ob-C
  :straight (:type built-in)
  :commands org-babel-execute:C)

(use-package ob-R
  :straight (:type built-in)
  :commands org-babel-execute:R)

(use-package ob-python
  :straight (:type built-in)
  :commands org-babel-execute:python)

(use-package ob-matlab
  :straight (:type built-in)
  :commands org-babel-execute:matlab)
#+END_SRC
** Non built-ins
#+BEGIN_SRC emacs-lisp :results none
(use-package org-superstar ; bullets in org mode
  :hook (org-mode . org-superstar-mode)
  :custom
  (org-hide-leading-stars t))

(use-package toc-org ; auto-generate tables of contents w/in org and markdown with a :TOC: tag
  :hook ((org-mode markdown-mode) . toc-org-mode))

(use-package evil-org ; functions to work with evil-mode in org-mode
  :general
  ;; bind evil-org functions manually rather than using evil-org-mode, which has some
  ;; conflicting bindings for my preferences
  ('normal org-mode-map
           "o" #'evil-org-open-below
           "O" #'evil-org-open-above)

  ('(normal insert) org-mode-map
   "C-;"   #'evil-org-org-insert-heading-respect-content-below
   "M-;"   #'evil-org-org-insert-todo-heading-respect-content-below))

(use-package org-journal
  :custom
  (org-journal-dir "~/org/journal")
  (org-journal-file-format "%m%d%Y")
  :general
  (my-leader-def
    "oj"   '(:ignore t :which-key "Org journal")
    "ojn" #'(org-journal-new-entry :which-key "new"))

  ('normal org-journal-mode-map
           "za" #'(org-cycle    :which-key "open fold")))
#+END_SRC
** Functions
#+BEGIN_SRC emacs-lisp :results none
(defun bad-parens-p ()
  "Return `t' if `check-parens' indicates unbalanced parens or quotes; otherwise `nil'"
  (interactive)
  (condition-case err
      (check-parens)
    (error (message "%s" (error-message-string err)) t)))

;;;###autoload
(defun +org/tangle-config ()
  "tangle my org-mode config file to an elisp file"
  (interactive)
  (find-file config-org)
  (org-babel-tangle-file config-org config-el)
  (with-temp-buffer
    (insert-file-contents config-el)
    (if (bad-parens-p)
        (progn
          (message "Unmatched parentheses detected in %s. Aborting exit." config-el)
          (keyboard-quit)))))

;;;###autoload
(defun +org/insert-subheading ()
  "insert a subheading in org mode and go to insert mode"
  (interactive)
  (evil-append-line 1)
  (org-insert-subheading 1))

;;;###autoload
(defun +org/insert-heading ()
  "insert a subheading in org mode and go to insert mode"
  (interactive)
  (org-insert-heading-respect-content)
  (evil-insert 1))

;;;###autoload
(defun +org/insert-todo ()
  "insert a subheading in org mode and go to insert mode"
  (interactive)
  (org-insert-todo-heading-respect-content)
  (evil-insert 1))

;;;###autoload
(defun +org/insert-heading-above ()
  "insert a subheading in org mode and go to insert mode"
  (interactive)
  (org-insert-heading-respect-content)
  (evil-insert 1))

;;;###autoload
(defun +org/insert-heading-above ()
  "insert an org heading above and jump into insert mode"
  (interactive)
  (evil-append-line 1)
  (move-beginning-of-line nil)
  (org-insert-heading))

;;;###autoload
(defun +org/insert-todo-above ()
  "insert an org todo above and jump into insert mode"
  (interactive)
  (evil-append-line 1)
  (move-beginning-of-line nil)
  (org-insert-todo-heading 1))

;;;###autoload
(defun +org-indent ()
  "indent in major mode - org-src-tab-acts-natively gave me issues"
  (interactive)
  (if (org-in-src-block-p)
      ;; (org-babel-do-in-edit-buffer
      ;;  (call-interactively #'indent-for-tab-command))
      (progn (org-edit-src-code)
             (indent-for-tab-command)
             (org-edit-src-exit))
    (indent-for-tab-command)))
#+END_SRC
* Windows, Buffers, Tabs
** Windows
#+BEGIN_SRC emacs-lisp :results none
(use-package ace-window
  :custom
  (aw-keys '(?j ?k ?l ?s ?d ?s ?h ?a))
  :general
  ("M-o" #'ace-window)

  ('evil-window-map
   "m" #'(ace-swap-window :which-key "move")))

(use-package winner ; Undo and redo window configs
  :straight (:type built-in)
  :defer 0.3
  :general
  ('evil-window-map
   "u" #'(winner-undo :which-key "undo window operation")
   "r" #'(winner-redo :which-key "redo window operation"))
  :config
  (winner-mode))
#+END_SRC
** Tabs
#+BEGIN_SRC emacs-lisp :results none
(use-package tab-bar
  :straight (:type built-in)
  :custom
  (tab-bar-new-button-show nil)
  (tab-bar-close-button-show nil)
  (tab-bar-show nil)
  :general
  ('normal
   "]t" #'(tab-bar-switch-to-next-tab :which-key "next tab")
   "[t" #'(tab-bar-switch-to-prev-tab :which-key "next-tab")
   "]T" #'(tab-bar-move-tab           :which-key "move tab right")
   "[T" #'(tab-bar-move-tab-to        :which-key "move tab left"))

  (my-leader-def
    "t"        '(:ignore t                    :which-key "Tab")
    "to"      #'(+tab-bar/open-and-rename     :which-key "new tab")
    "tl"      #'(tab-bar-switch-to-recent-tab :which-key "last tab")
    "t SPC g" #'(tab-bar-select-tab           :which-key "choose tab")
    "tg"      #'(tab-bar-switch-to-tab        :which-key "choose tab by name")
    "tn"      #'(tab-bar-switch-to-next-tab   :which-key "next tab")
    "tp"      #'(tab-bar-switch-to-prev-tab   :which-key "previous tab")
    "t SPC d" #'(tab-bar-close-tab-by-name    :which-key "close tab by name")
    "t,d"     #'(tab-bar-close-other-tabs     :which-key "close other tabs")
    "td"      #'(tab-bar-close-tab            :which-key "close tab")
    "tu"      #'(tab-bar-undo-close-tab       :which-key "undo close tab")
    "t SPC r" #'(tab-bar-rename-tab-by-name   :which-key "rename tab by name")
    "tr"      #'(tab-bar-rename-tab           :which-key "rename tab")))
#+END_SRC
*** Functions
#+BEGIN_SRC emacs-lisp :results none
(defun +tab-bar/open-and-rename ()
  (interactive)
  (tab-bar-new-tab)
  (call-interactively #'tab-bar-rename-tab))
#+END_SRC
* Editing
** Smartparens
#+BEGIN_SRC emacs-lisp :results none
(use-package smartparens ; pair delimiters automatically and functions to work with delimiters
  :defer 0.1
  :custom
  (sp-highlight-pair-overlay nil)
  (sp-highlight-wrap-overlay nil)
  (sp-highlight-wrap-tag-overlay nil)
  (sp-max-prefix-length 25)
  (sp-max-pair-length 4)
  (sp-escape-quotes-after-insert nil)
  (sp-show-pair-from-inside t)
  (sp-cancel-autoskip-on-backward-movement nil) ; quote pairs buggy otherwise
  :general
  ('normal
   ">" (general-key-dispatch #'evil-shift-right
         ")" #'(sp-forward-slurp-sexp :which-key "forward slurp")
         "(" #'(sp-backward-barf-sexp :which-key "backward barf"))
   "<" (general-key-dispatch #'evil-shift-left
         ")" #'(sp-forward-barf-sexp   :which-key "forward barf")
         "(" #'(sp-backward-slurp-sexp :which-key "backward slurp")))
  :config
  (smartparens-global-mode)
  (require 'smartparens-config) ; config for many languages

  ;; characters to not pair in org mode
  (eval-after-load 'smartparens-org '(progn
                                       (sp-local-pair 'org-mode "=" nil :actions nil)
                                       (sp-local-pair 'org-mode "~" nil :actions nil)
                                       (sp-local-pair 'org-mode "/" nil :actions nil)
                                       (sp-local-pair 'org-mode "_" nil :actions nil)
                                       (sp-local-pair 'org-mode "'" nil :actions nil)
                                       (sp-local-pair 'org-mode "*" nil :actions nil))))
#+END_SRC
** Miscellaneous
#+BEGIN_SRC emacs-lisp :results none
(use-package format-all ; format code functions
  :hook
  (js2-mode . format-all-mode)
  :init
  (defvar +format-with-lsp nil)
  :general
  (my-leader-def
    :states 'normal
    "=" #'(+format/buffer :which-key "format")
    :config
    (setq-default format-all-formatters
                  '(("TypeScript" prettier)
                    ("JavaScript" prettier)))))

(use-package move-text
  :general
  ('normal
   "]e" #'(move-text-down :which-key "move text down")
   "[e" #'(move-text-up   :which-key "move text up")))

(use-package avy ; jump to things in files similar to easymotion for vim
  :general
  ('normal
   "go"      #'(avy-goto-char-2     :which-key "2-chars")
   "g SPC o" #'(avy-goto-char-timer :which-key "timer")))

(use-package titlecase ; title case a line
  :general
  ('normal
   "g^" #'(titlecase-line :which-key "titlecase line"))

  ('visual
   "g^" #'titlecase-region :which-key "titlecase region"))
#+END_SRC
* System
** Terminal
#+BEGIN_SRC emacs-lisp :results none
(use-package terminal-here
  :general
  (my-leader-def
    "o"   '(:ignore t           :which-key "Open")
    "ot" #'terminal-here-launch :which-key "Launch terminal"))
#+END_SRC
** Eshell
#+BEGIN_SRC emacs-lisp :results none
(use-package eshell ; shell for elisp and regular shell commands
  ;; TODO delete
  :disabled t
  :defer-incrementally (em-alias em-banner em-basic em-cmpl
                                 em-dirs em-glob em-hist em-ls em-script em-term)
  :straight (:type built-in)
  :hook ((eshell-mode            . smartparens-mode)
         (eshell-first-time-mode . +eshell/init-keymaps)
         (eshell-post-command    . +eshell/init-aliases-h))
  :custom
  (eshell-prompt-function #'eshell/eshell-local-prompt-function)
  (eshell-directory-name (expand-file-name "eshell/" my/etc-dir))
  :custom-face
  (eshell-ls-archive    ((t (:foreground "#bdae93"))))
  (eshell-ls-backup     ((t (:foreground "#a89984"))))
  (eshell-ls-clutter    ((t (:foreground "#fe8019" :bold t))))
  (eshell-ls-directory  ((t (:foreground "#fabd2f"))))
  (eshell-ls-executable ((t (:bold t))))
  (eshell-ls-missing    ((t (:foreground "fb4933" :bold t))))
  (eshell-ls-product    ((t (:foreground "#9d0006"))))
  (eshell-ls-readonly   ((t (:foreground "#d5c4a1"))))
  (eshell-ls-special    ((t (:foreground "#fabd2f" :bold t))))
  (eshell-ls-symlink    ((t (:foreground "#fb4933"))))
  (eshell-ls-unreadable ((t (:foreground "#fb4933" :bold t))))
  :general
  (my-leader-def
    "oe"      #'eshell
    "o SPC e" #'(lambda () (interactive) (eshell t) :which-key "new eshell")
    "ov"       '(:ignore t                          :which-key "Vertical")
    "ove"     #'(+eshell/other-window               :which-key "eshell in vsplit"))
  :config
  (evil-collection-init 'eshell)

  ;; Aliases
  (advice-add #'eshell-write-aliases-list :override #'ignore))
#+END_SRC
**** Functions
#+BEGIN_SRC emacs-lisp :results none
;;;###autoload
(defun +eshell/init-keymaps ()
  "initialize eshell keybindings"
  (general-def 'normal eshell-mode-map
    "C-n" (lambda ()
            "jump into insert mode before finding the next match in eshell"
            (interactive)
            (evil-append-line 1)
            (general-simulate-key "C-n"))

    "C-p" (lambda ()
            "jump into insert mode before finding the previous match in eshell"
            (interactive)
            (evil-append-line 1)
            (general-simulate-key "C-p")))

  (general-def 'insert eshell-mode-map
    "C-n"                        #'eshell-next-matching-input-from-input
    "C-p"                        #'eshell-previous-matching-input-from-input
    [remap company-manual-begin] #'completion-at-point)

  (general-def '(insert normal) eshell-mode-map
    "C-l" #'+eshell/clear)

  (general-def 'normal eshell-mode-map
    "q" #'kill-this-buffer))

;;;###autoload
(defun +eshell/init-aliases-h ()
  "initialize eshell aliases"
  (dolist (var '(("s" "sudo")

                 ("l" "ls -A")
                 ("ll" "ls -l")
                 ("la" "ls -lA")

                 ("g"    "git")
                 ("gs"   "git status")
                 ("gl"   "git log")
                 ("ga"   "git add")
                 ("gaa"  "git add -A")
                 ("gcm"  "git commit -m")
                 ("gcam" "git commit -a m")
                 ("gr"   "git reset")
                 ("grs"  "git reset --soft HEAD~1")

                 ("gp"   "git push -u origin master")
                 ("gF"   "git pull")))
    (add-to-list 'eshell-command-aliases-list var)))

;;;###autoload
(defun +eshell/clear ()
  "eshell clear screen"
  (interactive)
  (let ((inhibit-read-only t))
    (erase-buffer)
    (eshell-send-input)))

;;;###autoload
(defun +eshell/other-window ()
  "open eshell in a vsplit"
  (interactive)
  (evil-window-vsplit)
  (eshell t))

;; https://blog.liangzan.net/blog/2012/12/12/customizing-your-emacs-eshell-prompt/
;;;###autoload
(defun pwd-repl-home (pwd)
  "shortened version of /home/ex/* for eshell prompt"
  (interactive)
  (let* ((home (expand-file-name (getenv "HOME")))
         (home-len (length home)))
    (if (and
         (>= (length pwd) home-len)
         (equal home (substring pwd 0 home-len)))
        (concat "~" (substring pwd home-len))
      pwd)))

;; https://github.com/howardabrams/dot-files/blob/master/emacs-eshell.org
;;;###autoload
(defun eshell/eshell-local-prompt-function ()
  "A prompt for eshell that works locally (in that is assumes
              that it could run certain commands) in order to make a prettier,
              more-helpful local prompt."
  (interactive)
  (let* ((pwd       (eshell/pwd))
         (directory (pwd-repl-home pwd))

         (dark-env  (eq 'dark (frame-parameter nil 'background-mode)))
         (for-bars               `(:foreground "#98971a" :weight bold))
         (for-dir   (if dark-env `(:foreground "#8ec07c" :weight bold)
                      `(:foreground "blue" :weight bold))))

    (concat
     (propertize directory 'face for-dir)
     (propertize " # " 'face `(:foreground "#ebdbb2")))))
#+END_SRC
** Tramp
#+BEGIN_SRC emacs-lisp :results none
(use-package tramp ; access remote files within emacs
  :disabled t
  :straight (:type built-in)
  :custom
  (tramp-autosave-directory    (expand-file-name "tramp/auto-save/" my/etc-dir))
  (tramp-persistency-file-name (expand-file-name "tramp/persistency.el" my/etc-dir))
  :general
  (my-localleader-def
    "t"  '(:ignore t            :which-key "Tramp ssh")
    "tr" #'(+tramp/ssh-rlogin   :which-key "rlogin")
    "tc" #'(+tramp/ssh-cascades :which-key "cascades")
    "tp" #'(+tramp/ssh-pascal   :which-key "pascal")))
#+END_SRC
*** Functions
#+BEGIN_SRC emacs-lisp :results none
;;;###autoload
(defun +tramp/ssh-rlogin ()
  "ssh into rlogin through tramp"
  (interactive)
  (find-file "/sshx:lancebergeron@rlogin.cs.vt.edu:~/"))

;;;###autoload
(defun +tramp/ssh-cascades ()
  "ssh into cascades through tramp"
  (interactive)
  (find-file "/sshx:lancebergeron@cascades1.arc.vt.edu:~/"))

;;;###autoload
(defun +tramp/ssh-pascal ()
  "ssh into pascal through tramp"
  (interactive)
  (find-file "/sshx:cmda02@pascal.math.vt.edu|sshx:cmda02@node02:~/"))
#+END_SRC
** Dired
#+BEGIN_SRC emacs-lisp :results none
(use-package dired ; TODO how to move stuff
  :straight (:type built-in)
  :custom
  (dired-auto-revert-buffer) ; don't prompt to revert
  (dired-recursive-copies 'always)
  :general
  ('normal
   "-"  #'(dired-jump :which-key "open dired"))
  :config
  (evil-collection-init 'dired)

  (put 'dired-find-alternate-file 'disabled nil)

  (general-def 'normal dired-mode-map
    ";" #'dired-find-alternate-file ; select a directory in the same buffer
    "i" #'+dired/edit
    "-" #'+dired/up-dir))

(use-package dired-x
  :straight (:type built-in)
  :hook (dired-mode . dired-omit-mode)
  :custom
  (dired-omit-files "^\\..$\\|^.$")) ; hide .. and ../ in dired
#+END_SRC
*** Functions
#+BEGIN_SRC emacs-lisp :results none
(defun +dired/edit ()
  "stay in normal mode to edit dired file names"
  (interactive)
  (dired-toggle-read-only)
  (evil-normal-state)
  (evil-forward-char))

(defun +dired/up-dir ()
  "navigate up a directory in dired in the same buffer"
  (interactive)
  (find-alternate-file ".."))
#+END_SRC
** Miscellaneous
#+BEGIN_SRC emacs-lisp :results none
(use-package helpful ; better help menu
  :defer 0.3
  :general
  ('normal
   "gp" #'helpful-at-point)
  ('normal helpful-mode-map
           "q" #'quit-window)

  ([remap describe-command] #'helpful-command
   [remap describe-key]     #'helpful-key
   [remap describe-symbol]  #'helpful-symbol)
  :config
  (evil-collection-inhibit-insert-state 'helpful-mode-map))

(use-package gcmh ; Garbage collect in idle time
  :defer 0.4
  :commands gcmh-idle-garbage-collect
  :custom
  (gcmh-idle-delay 10)
  (gcmh-high-cons-threshold 16777216)
  :config
  (gcmh-mode)
  (add-function :after after-focus-change-function #'gcmh-idle-garbage-collect))

(use-package dumb-jump ; better way to search code TODO
  :disabled t
  :defer t
  :custom
  (dumb-jump-default-project "~/code")
  (dumb-jump-selector 'ivy)
  (dumb-jump-prefer-searcher 'rg)
  :config
  (add-hook 'xref-backend-functions #'dumb-jump-xref-activate))

(use-package undo-tree ; Persistent Undos
  :hook (after-init . global-undo-tree-mode)
  :custom
  (undo-limit 10000)
  (undo-tree-history-directory-alist (list (cons "." (expand-file-name "undo/" my/etc-dir))))
  (undo-tree-auto-save-history t)
  (evil-undo-system 'undo-tree)
  :general
  (my-leader-def
    "fu" #'(undo-tree-visualize :which-key "undo")))

(use-package exec-path-from-shell ; Use system $PATH variable for eshell, commands, etc.
  :defer t
  :hook (after-init . (lambda () (setq exec-path-from-shell-arguments '("-l"))
                        (exec-path-from-shell-initialize))))

;; TODO
(use-package request
  :disabled t
  :defer t
  :custom
  (request-storage-directory (expand-file-name "request/" my/etc-dir)))

(use-package google-this
  :general
  (my-localleader-def
    "gt" #'google-this-symbol
    "gs" #'google-this-search)

  ('visual
   "gs" (lambda () (interactive)
          (google-this-region t t))))

(use-package chatgpt-shell
  :general
  (my-localleader-def
    "gc" #'chatgpt-shell)

  :config
  (setq chatgpt-shell-model-version "gpt-3.5-turbo")
  (setq chatgpt-shell-openai-key (read-file-contents "~/secrets/gpt_api_key")))

(use-package ace-link
  :defer t)
#+END_SRC
** Functions
#+BEGIN_SRC emacs-lisp :results none
;;;###autoload
(defun read-file-contents (file-path)
  "Read the contents of FILE-PATH and return it as a string."
  (with-temp-buffer
    (insert-file-contents file-path)
    (buffer-string)))
#+END_SRC
* Filetype Specific
** C family
#+BEGIN_SRC emacs-lisp :results none
(use-package cc-mode
  :straight (:type built-in)
  :hook (c-mode . +cc/company-mode)
  :mode ("\\.cu\\'" . c-mode)
  :custom
  (c-basic-offset 4)
  (c-default-style "linux")
  :general
  ('c-mode-base-map
   "M-;" #'my/append-semicolon))

(use-package gdb-mi ; TODO
  :straight (:type built-in)
  :general
  ('c-mode-map
   "C-c g" #'(gdb :which-key "gdb")))
#+END_SRC
*** Functions
#+BEGIN_SRC emacs-lisp :results none
;;;###autoload
(defun +cc/company-mode ()
  "company backends for c-mode"
  (setq-local company-backends
              '((company-clang
                 company-cmake
                 company-capf
                 company-files))))
#+END_SRC
** R
#+BEGIN_SRC emacs-lisp :results none
(use-package ess
  :disabled t
  :hook (ess-r-mode . +ess/company-mode)
  :general
  ('(normal insert) ess-mode-map
   "C-;" #'ess-eval-line
   "M-;" #'ess-eval-buffer)

  ('visual ess-mode-map
           "C-;" #'ess-eval-region)

  ('(normal insert) ess-mode-map
   :prefix "C-c"
   "o" #'R
   "b" #'(ess-eval-buffer   :which-key "eval R buffer")
   "r" #'(ess-eval-region   :which-key "eval R region")
   "f" #'(ess-eval-function :which-key "eval R function")
   "h" #'(ess-doc-map       :which-key "R help")))
#+END_SRC
*** Functions
#+BEGIN_SRC emacs-lisp :results none
;;;###autoload
(defun +ess/company-mode ()
  "company backends for r mode"
  (setq-local company-backends
              '((company-R-args
                 company-R-objects
                 company-dabbrev-code
                 company-files
                 company-yasnippet))))
#+END_SRC
** Markdown
#+BEGIN_SRC emacs-lisp :results none
(use-package markdown-mode
  :general
  ('normal markdown-mode-map "RET" #'markdown-follow-thing-at-point))

(use-package pandoc-mode
  :hook (markdown-mode . pandoc-mode)
  :general
  ('markdown-mode-map
   :prefix "C-c"
   "e" #'(pandoc-main-hydra/body :which-key "pandoc")))

(use-package markdown-toc ; create a table of contents
  :general
  ('markdown-mode-map
   :prefix "C-c"
   "t" #'markdown-toc-generate-toc))
#+END_SRC
** Python
#+BEGIN_SRC emacs-lisp :results none
(use-package ein ; work with ipynb files
  :disabled t
  :mode ("\\.ipynb\\'" . ein:ipynb-mode)
  :hook (ipynb-mode . display-line-numbers-mode)
  :custom
  (ein:output-area-inlined-images t)
  :general
  ('ein:notebook-mode-map
   "C-j" #'ein:worksheet-goto-next-input-km
   "C-k" #'ein:worksheet-goto-prev-input-km
   "M-:" #'ein:worksheet-execute-cell-and-insert-below-km
   "M-j" #'ein:worksheet-move-cell-down-km
   "M-k" #'ein:worksheet-move-cell-up-km
   "M-:" #'ein:worksheet-insert-cell-above-km
   "M-;" #'ein:worksheet-insert-cell-below-km
   "C-;" #'ein:worksheet-execute-cell-km
   [remap evil-write] #'ein:notebook-save-notebook-command)

  ('normal ein:notebook-mode-map
           :prefix "C-c"
           "d"   #'ein:worksheet-delete-cell
           "w"   #'ein:notebook-save-notebook-command
           "k"   #'ein:worksheet-kill-cell-km
           "c"   #'ein:worksheet-clear-all-output-km
           "q"   #'ein:notebook-close
           "SPC" #'ein:worksheet-execute-all-cells
           "r"   #'ein:notebook-restart-session-command)

  (my-leader-def
    "ei"   '(:ignore t :which-key "Ein")
    "eir" #'(ein:run   :which-key "run")
    "eis" #'(ein:stop  :which-key "stop")))

(use-package jupyter :defer t)

(use-package ob-jupyter
  :straight jupyter
  :commands org-babel-execute:jupyter-python)
#+END_SRC
** Matlab
#+BEGIN_SRC emacs-lisp :results none
(use-package matlab-mode
  :mode ("\\.m\\'" . matlab-mode)
  :general
  ('normal matlab-shell-mode-map
           "C-d" #'evil-scroll-down)

  (my-leader-def
    "oms" #'(matlab-shell :which-key "matlab shell")
    "omt" #'(matlab-shell-tab :which-key "matlab shell tab")
    "omi" (lambda () (interactive)
            (switch-to-buffer "*Inferior Matlab*"))))
#+END_SRC
** Latex
#+BEGIN_SRC emacs-lisp :results none
(use-package auctex
  :defer t
  :general
  ('TeX-mode-map
   :prefix "C-c"
   "e" (lambda () (interactive)
         (save-buffer) (TeX-command-master) :which-key "export")))
#+END_SRC
** Javascript
#+BEGIN_SRC emacs-lisp :results none
(use-package js2-mode
  :mode ("\\.js\\'" . js2-mode)
  :custom (js2-basic-offset 2))

(use-package typescript-mode
  :defer t
  :custom
  (typescript-indent-level 2)
  (typescript-auto-indent-flag t))

(use-package json-mode
  :defer t)
#+END_SRC
** Scala
#+BEGIN_SRC emacs-lisp :results none
(use-package scala-mode
  :defer t)
#+END_SRC
** Go
#+BEGIN_SRC emacs-lisp :results none
(use-package go-mode
  :defer t)
#+END_SRC
** Yaml
#+BEGIN_SRC emacs-lisp :results none
(use-package yaml-mode
  :mode ("\\.gotmpl\\'" . yaml-mode))
#+END_SRC
** Docker
#+BEGIN_SRC emacs-lisp :results none
(use-package dockerfile-mode
  :defer t)
#+END_SRC
** HTML & CSS
#+BEGIN_SRC emacs-lisp :results none
(use-package web-mode
  :mode ("\\.html\\'"   . web-mode)
  :mode ("\\.svelte\\'" . web-mode)
  :mode ("\\.css\\'"    . web-mode)
  :custom
  (web-mode-code-indent-offset 2)
  (web-mode-markup-indent-offset 2)
  (web-mode-enable-auto-closing t)
  (web-mode-enable-auto-pairing t))

(use-package html-mode
  :straight (:type built-in)
  :mode ("\\.html\\'" . html-mode))

(use-package emmet-mode
  :hook (web-mode . emmet-mode)
  :general
  ('insert emmet-mode-keymap
           "TAB" #'emmet-expand-line))
#+END_SRC
** Elisp Mode
#+BEGIN_SRC emacs-lisp :results none
(use-package elisp-mode
  :straight (:type built-in)
  :general
  ('(normal insert) emacs-lisp-mode-map
   :prefix "C-c"
   "C-c" #'eval-buffer
  ))
#+END_SRC
